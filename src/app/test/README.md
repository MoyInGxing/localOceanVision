# OceanVision API 测试工具

这个测试工具用于诊断监测点API调用问题，帮助判断前端显示"没有找到监测点"的原因。

## 问题描述

- 前端显示："没有找到监测点"
- 后端日志：显示API被调用
- 需要诊断：API调用的具体情况和数据格式

## 测试工具

### 1. 浏览器测试 (推荐)

**文件**: `browser-api-test.js`

**使用方法**:
1. 打开浏览器开发者工具 (F12)
2. 切换到 Console 标签
3. 复制 `browser-api-test.js` 的全部内容
4. 粘贴到控制台并按回车
5. 运行测试命令：
   ```javascript
   testMonitoringPointsAPI()
   ```
   或
   ```javascript
   quickTest()
   ```

**优势**:
- 无需安装依赖
- 直接在浏览器环境测试
- 能检测CORS问题
- 实时查看网络请求

### 2. Node.js 测试

**文件**: `api-test.js`

**使用方法**:
1. 进入测试目录：
   ```bash
   cd src/app/test
   ```

2. 安装依赖：
   ```bash
   npm install
   ```

3. 运行测试：
   ```bash
   npm test
   ```
   或
   ```bash
   node api-test.js
   ```

**优势**:
- 详细的网络分析
- 不受浏览器CORS限制
- 可以测试多个API端点

## 测试内容

### 检查项目

1. **网络连接**
   - API服务器是否可达
   - 响应时间
   - HTTP状态码

2. **数据格式**
   - 响应是否为JSON格式
   - 数据结构是否符合前端期望
   - 必需字段是否存在

3. **前端兼容性**
   - 模拟前端数据处理逻辑
   - 检查为什么显示"没有找到监测点"

4. **错误诊断**
   - CORS跨域问题
   - 数据类型不匹配
   - 空数据处理

### 期望的数据格式

前端期望的API响应格式：
```json
{
  "points": [
    {
      "id": "string",
      "name": "string",
      "location": {
        "lat": "number",
        "lng": "number"
      },
      "basin": "string",
      "temperature": "number",
      "ph": "number",
      "oxygen": "number",
      "turbidity": "number"
    }
  ]
}
```

## 常见问题和解决方案

### 1. 数据格式不匹配

**问题**: API返回的数据格式与前端期望不符

**解决方案**:
- 检查后端是否返回 `{ points: [...] }` 格式
- 或修改前端代码适配实际返回格式

**前端修改示例**:
```javascript
// 原代码
const points = data.points || [];

// 修改为兼容多种格式
const points = Array.isArray(data) ? data : (data.points || []);
```

### 2. CORS跨域问题

**问题**: 浏览器阻止跨域请求

**解决方案**:
- 检查后端是否设置了正确的CORS头
- 在浏览器控制台查看是否有CORS错误

**后端CORS设置示例**:
```javascript
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));
```

### 3. 数据为空

**问题**: API返回空数组或null

**解决方案**:
- 检查数据库是否有监测点数据
- 检查后端查询逻辑
- 验证数据库连接

### 4. 网络连接问题

**问题**: 无法连接到API服务器

**解决方案**:
- 确认后端服务器运行在正确端口 (8082)
- 检查防火墙设置
- 验证API URL是否正确

## 测试结果解读

### 成功的测试结果
```
✓ API调用成功
✓ 找到 points 字段
✓ points 是数组，包含 N 个元素
✓ 所有必需字段都存在
✓ 字段类型正确
✓ 前端应该能正常显示监测点
```

### 失败的测试结果
```
✗ API调用失败: 404
✗ 数据格式不匹配
✗ 缺少必需字段: [id, name]
⚠ 前端会显示"没有找到监测点"
```

## 调试步骤

1. **首先运行浏览器测试**
   - 快速检查基本连接和CORS问题

2. **查看浏览器网络标签**
   - 检查实际的HTTP请求和响应

3. **运行Node.js测试**
   - 获取详细的技术分析

4. **根据测试结果修复问题**
   - 修改后端数据格式
   - 或调整前端处理逻辑

5. **重新测试验证修复**

## 联系支持

如果测试工具无法解决问题，请提供：
- 测试工具的完整输出
- 浏览器控制台的错误信息
- 后端服务器的日志
- API的实际响应数据